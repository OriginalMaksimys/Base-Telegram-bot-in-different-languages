IDENTIFICATION DIVISION.
PROGRAM-ID. TELEGRAM-BOT.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
FILE SECTION.

WORKING-STORAGE SECTION.
01 EXIT-COMMAND PIC X(4) VALUE "exit".
01 TELEGRAM-OBJECT.
   05 TOKEN PIC X(1) VALUE SPACES.
   05 CLEAR-UPDATES-ON-START PIC X(1) VALUE "Y".
   05 WHITE-LIST-USERS PIC 9(18) OCCURS 1 TO 10 TIMES DEPENDING ON WHITE-LIST-USERS-COUNT.
   05 WHITE-LIST-USERS-COUNT PIC 9(2) VALUE 0.
   05 ADMINS PIC 9(18) OCCURS 1 TO 10 TIMES DEPENDING ON ADMINS-COUNT.
   05 ADMINS-COUNT PIC 9(2) VALUE 0.
   05 BOT-ID PIC 9(18) VALUE 0.
01 CURRENT-DATETIME PIC X(26).
01 ERROR-MESSAGE PIC X(1024).
01 COMMON-MESSAGE PIC X(1024).
01 CONSOLE-COLOR PIC 9(1) VALUE 2.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INITIALIZE-TELEGRAM-OBJECT.
    PERFORM REGISTER-EVENT-HANDLERS.
    PERFORM START-TELEGRAM-BOT.
    PERFORM MAIN-LOOP.
    STOP RUN.

INITIALIZE-TELEGRAM-OBJECT.
    MOVE SPACES TO TOKEN.
    MOVE "Y" TO CLEAR-UPDATES-ON-START.
    MOVE 0 TO WHITE-LIST-USERS-COUNT.
    MOVE 0 TO ADMINS-COUNT.
    MOVE 0 TO BOT-ID.

REGISTER-EVENT-HANDLERS.
    SET ADDRESS OF TELEGRAM-OBJECT TO ADDRESS OF TELEGRAM-OBJECT.
    CALL "REGISTER-LOG-COMMON-EVENT-HANDLER" USING TELEGRAM-OBJECT, TELEGRAM-LOG-COMMON-EVENT-HANDLER.
    CALL "REGISTER-LOG-ERROR-EVENT-HANDLER" USING TELEGRAM-OBJECT, TELEGRAM-LOG-ERROR-EVENT-HANDLER.

START-TELEGRAM-BOT.
    CALL "START-TELEGRAM-BOT" USING TELEGRAM-OBJECT.

MAIN-LOOP.
    PERFORM UNTIL EXIT-COMMAND = FUNCTION LOWER-CASE(FUNCTION TRIM(CONSOLE-INPUT))
        PERFORM GET-CONSOLE-INPUT
        IF EXIT-COMMAND = FUNCTION LOWER-CASE(FUNCTION TRIM(CONSOLE-INPUT))
            PERFORM TERMINATE-PROGRAM
        END-IF
    END-PERFORM.

GET-CONSOLE-INPUT.
    ACCEPT CONSOLE-INPUT FROM CONSOLE.

TERMINATE-PROGRAM.
    CALL "ENVIRONMENT-EXIT" USING 0.

TELEGRAM-LOG-COMMON-EVENT-HANDLER.
    MOVE CURRENT-DATETIME TO CURRENT-DATETIME.
    MOVE FUNCTION CONCATENATE(CURRENT-DATETIME, ":", COMMON-MESSAGE) TO COMMON-MESSAGE.
    DISPLAY COMMON-MESSAGE WITH FOREGROUND-COLOR CONSOLE-COLOR.
    MOVE 2 TO CONSOLE-COLOR.

TELEGRAM-LOG-ERROR-EVENT-HANDLER.
    MOVE CURRENT-DATETIME TO CURRENT-DATETIME.
    MOVE FUNCTION CONCATENATE(CURRENT-DATETIME, ":", ERROR-MESSAGE) TO ERROR-MESSAGE.
    DISPLAY ERROR-MESSAGE WITH FOREGROUND-COLOR 1.
    MOVE 2 TO CONSOLE-COLOR.

